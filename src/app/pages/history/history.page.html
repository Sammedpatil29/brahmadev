<ion-header class="ion-no-border bg-white">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="back()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>My Visits</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-horizontal">
 <div class="mb-3">
   @if(!isLoading){
    @for (item of pastVisits; track $index) {
      <div class="visit-card p-0" (click)="item.isExpanded = !item.isExpanded">
        <div class="card-main">
          <div class="info-text">
            <p><strong>Owner Name:</strong> {{item.ownerName | titlecase}}</p>
            <p>
              <strong>Owner Contact:</strong> 
              <a [href]="'tel:' + item.ownerContact" class="tel-link" (click)="$event.stopPropagation()">{{item.ownerContact}}</a>
            </p>
            <p><strong>Response:</strong> {{item.response | titlecase}}</p>
            <p><strong>Visit On:</strong> {{item.createdAt | date: 'd MMM yyyy'}}, {{item.createdAt | date: 'h:mm a'}}</p>
          </div>
          
          <div class="side-actions">
            <button class="action-btn call" (click)="$event.stopPropagation()">
              <a [href]="'tel:' + item.ownerContact"><ion-icon name="call"></ion-icon></a>
            </button>
            <button class="action-btn map" (click)="openMap(item.lat, item.lng); $event.stopPropagation()">
              <ion-icon name="navigate-circle-outline"></ion-icon>
            </button>
          </div>
        </div>

        <div class="specs-container">
          <div class="spec-item">
            <span class="spec-label">Aprx. Area</span>
            <span class="spec-value">{{item.builtUpArea}}</span>
          </div>
          <div class="spec-item">
            <span class="spec-label">No. of floors</span>
            <span class="spec-value">{{item.floors}}</span>
          </div>
          <div class="spec-image" (click)="openImage(item); $event.stopPropagation()">
             <ion-icon name="image"></ion-icon>
          </div>
        </div>

        @if (item.isExpanded) {
          <div class="expanded-details">
            <div class="detail-row">
              @if (item.engineerName) {
                <p><strong>Engineer Name:</strong> {{item.engineerName}}</p>
              }
              @if (item.engineerContact) {
                <p><strong>Engineer Contact:</strong> {{item.engineerContact}} 
                  <a [href]="'tel:' + item.engineerContact" (click)="$event.stopPropagation()"><ion-icon name="call" class="mini-call"></ion-icon></a>
                </p>
              }
            </div>
            <div class="detail-row">
              @if (item.contractorName) {
                <p><strong>Contractor Name:</strong> {{item.contractorName}}</p>
              }
              @if (item.contractorContact) {
                <p><strong>Contractor Contact:</strong> {{item.contractorContact}} 
                  <a [href]="'tel:' + item.contractorContact" (click)="$event.stopPropagation()"><ion-icon name="call" class="mini-call"></ion-icon></a>
                </p>
              }
            </div>
          </div>
        }
      </div>
    }
  } @else {
    <div class="loader">
      <ion-spinner color="primary"></ion-spinner>
    </div>
  }
 </div>
</ion-content>